<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Upload Medical Report - MediCure AI</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        * { margin:0; padding:0; box-sizing:border-box; }
        html,body { height:100%; }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #0f0c29 0%, #302b63 50%, #24243e 100%);
            min-height:100vh; color:#fff; overflow-x:hidden; padding-top:70px;
        }

        nav {
            background: rgba(255,255,255,0.08); backdrop-filter: blur(20px);
            padding:12px 0; position:fixed; top:0; width:100%; z-index:1000;
            box-shadow: 0 8px 32px rgba(0,0,0,0.2); border-bottom:1px solid rgba(255,255,255,0.1);
        }

        .nav-container { max-width:1400px; margin:0 auto; display:flex; justify-content:space-between; align-items:center; padding:0 30px; width:100%; }
        .logo { font-size:18px; font-weight:800; display:flex; gap:10px; align-items:center; color:#667eea; text-decoration:none; }
        .nav-links { display:flex; gap:25px; list-style:none; flex:1; justify-content:flex-end; }
        .nav-links a { color:#fff; text-decoration:none; font-weight:600; font-size:.9rem; padding:8px 12px; border-radius:8px; }

        .main-container { max-width:1400px; margin:20px auto; display:grid; grid-template-columns:1fr 1fr; gap:30px; align-items:start; padding:0 30px; }
        .upload-container, .summary-container { background: rgba(255,255,255,0.95); border-radius:20px; box-shadow:0 20px 60px rgba(0,0,0,0.3); overflow:hidden; color:inherit; }
        .summary-container { min-height:500px; }

        .header { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color:white; padding:30px; text-align:center; }
        .content { padding:40px; }
        .upload-section { background:#f8f9fa; border:2px dashed #667eea; border-radius:15px; padding:40px; text-align:center; transition:all .3s ease; color:#333; }
        .upload-section:hover { border-color:#764ba2; background:#f0f1ff; }

        .upload-icon { font-size:60px; color:#667eea; margin-bottom:20px; }
        input[type="file"] { display:none; }
        .file-label { display:inline-block; background:white; color:#667eea; padding:12px 30px; border-radius:8px; cursor:pointer; border:2px solid #667eea; font-weight:600; }
        .file-name { display:block; margin-top:15px; color:#666; font-size:14px; min-height:20px; }

        .upload-btn { background: linear-gradient(135deg,#667eea 0%,#764ba2 100%); color:white; border:none; padding:15px 50px; border-radius:8px; font-size:16px; font-weight:600; cursor:pointer; margin-top:20px; }
        .upload-btn:disabled { opacity:0.6; cursor:not-allowed; }

        .loading { display:none; text-align:center; padding:30px; color:#333; }
        .loading.active { display:block; }
        .spinner { border:4px solid #f3f3f3; border-top:4px solid #667eea; border-radius:50%; width:50px; height:50px; animation:spin 1s linear infinite; margin:0 auto 20px; }
        @keyframes spin { 0% { transform:rotate(0deg);} 100% { transform:rotate(360deg);} }

        .summary-content { padding:30px; min-height:450px; }
        /* Keep summary-display stable so it doesn't collapse during reflow */
        .summary-display {
            background:#f8f9fa; border-radius:10px; padding:25px; min-height:350px; white-space:pre-wrap; line-height:1.8;
            color:#333; font-size:15px; border:2px solid #e0e0e0; display:block;
            /* don't force !important here to keep code maintainable; min-height prevents collapse */
            word-break: break-word;
        }

        .summary-controls { margin-top:12px; display:flex; gap:10px; align-items:center; }
        .btn-clear { background:#fff3f0; color:#c03535; border:1px solid #f5c2c2; padding:8px 12px; border-radius:8px; cursor:pointer; font-weight:600; }

        .status-badge { display:inline-block; padding:8px 16px; border-radius:20px; font-size:13px; margin-bottom:15px; font-weight:600; }
        .status-waiting { background:#e3f2fd; color:#1976d2; }
        .status-processing { background:#fff3e0; color:#f57c00; }
        .status-complete { background:#d4edda; color:#155724; }
        .status-error { background:#f8d7da; color:#721c24; }

        .report-metadata { background:#e8f4f8; border-left:4px solid #667eea; padding:15px; margin-bottom:20px; border-radius:8px; font-size:13px; color:#555; }
        .report-history { background:#fff3cd; border-left:4px solid #ffc107; padding:12px; margin-bottom:15px; border-radius:8px; font-size:12px; color:#856404; }
        .report-history a { color:#667eea; text-decoration:none; font-weight:600; cursor:pointer; }

        footer { text-align:center; padding:25px 20px; background: rgba(0,0,0,0.3); border-top:1px solid rgba(255,255,255,0.1); color:#b8c5d6; font-size:.85rem; margin-top:40px; }

        @media (max-width:968px) {
            .main-container { grid-template-columns:1fr; }
            .nav-links { display:none; }
        }
        @media (max-width:768px) { body { padding-top:60px; } }
    </style>
</head>
<body>
    <nav>
        <div class="nav-container">
            <a href="main.html" class="logo">
                <svg width="28" height="28" viewBox="0 0 100 100" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <rect x="15" y="30" width="70" height="55" rx="8" fill="url(#grad1)" stroke="#667eea" stroke-width="2"/>
                    <rect x="25" y="15" width="50" height="20" rx="6" fill="url(#grad2)" stroke="#764ba2" stroke-width="2"/>
                    <circle cx="50" cy="20" r="4" fill="#f093fb"/>
                    <path d="M45 50 L55 50 M50 45 L50 55" stroke="white" stroke-width="3" stroke-linecap="round"/>
                    <defs>
                        <linearGradient id="grad1" x1="0%" y1="0%" x2="100%" y2="100%">
                            <stop offset="0%" style="stop-color:#667eea;stop-opacity:1" />
                            <stop offset="100%" style="stop-color:#764ba2;stop-opacity:1" />
                        </linearGradient>
                        <linearGradient id="grad2" x1="0%" y1="0%" x2="100%" y2="100%">
                            <stop offset="0%" style="stop-color:#764ba2;stop-opacity:1" />
                            <stop offset="100%" style="stop-color:#f093fb;stop-opacity:1" />
                        </linearGradient>
                    </defs>
                </svg>
                MediCure AI
            </a>

            <ul class="nav-links">
                <li><a href="main.html">Home</a></li>
                <li><a href="uploadreport.html">Upload PDF</a></li>
                <li><a href="diseases.html">Disease Prediction</a></li>
                <li><a href="remedies.html">Home Remedies</a></li>
                <li><a href="chatbot.html">Medical Chat</a></li>
                <li><a href="doctor.html">Consult Doctor</a></li>
                <li><a href="#" onclick="logout(event)" class="logout-btn">Logout</a></li>
            </ul>
        </div>
    </nav>

    <div class="main-container">
        <div class="upload-container">
            <div class="header">
                <h1>üè• Medical Report Analyzer</h1>
                <p>Upload your medical report for instant AI analysis</p>
            </div>

            <div class="content">
                <div class="upload-section">
                    <div class="upload-icon">üìÑ</div>
                    <h3 style="margin-bottom:10px; color:#333;">Upload Medical Report</h3>
                    <p style="color:#666; margin-bottom:20px;">PDF files only</p>

                    <form id="uploadForm">
                        <div class="file-input-wrapper">
                            <input type="file" id="pdfFile" accept="application/pdf" />
                            <label for="pdfFile" class="file-label">Choose File</label>
                            <span class="file-name" id="fileName"></span>
                        </div>
                        <button type="submit" class="upload-btn" id="uploadBtn">Analyze Report</button>
                    </form>
                </div>

                <div class="loading" id="loading" aria-hidden="true">
                    <div class="spinner" aria-hidden="true"></div>
                    <p style="color:#667eea; font-weight:600;">Processing your report...</p>
                    <p style="color:#999; font-size:13px; margin-top:10px;">AI is analyzing the document</p>
                </div>
            </div>
        </div>

        <div class="summary-container">
            <div class="header">
                <h1>üìã Analysis Summary</h1>
                <p>Your report analysis appears here</p>
            </div>

            <div class="summary-content">
                <div id="statusBadge" class="status-badge status-waiting">‚è≥ Waiting for upload</div>
                <div id="reportHistory" style="display:none;"></div>
                <div id="reportMetadata" style="display:none;"></div>

                <div class="summary-display" id="summaryDisplay">
No report has been uploaded yet.

Upload a medical report on the left to see the AI-powered analysis here.

The summary will include:
‚Ä¢ Important medical findings
‚Ä¢ Test results
‚Ä¢ Abnormal values
‚Ä¢ Diagnosis information
‚Ä¢ Critical observations
                </div>

                <div class="summary-controls" style="margin-top:12px;">
                    <button id="clearSummaryBtn" class="btn-clear" title="Clear the visible summary">Clear Summary</button>
                </div>
            </div>
        </div>
    </div>

    <footer><p>&copy; 2024 MediCure AI. All rights reserved.</p></footer>

    <script>
    (function(){
        // Elements
        const fileInput = document.getElementById('pdfFile');
        const fileNameEl = document.getElementById('fileName');
        const uploadForm = document.getElementById('uploadForm');
        const uploadBtn = document.getElementById('uploadBtn');
        const loading = document.getElementById('loading');
        const statusBadge = document.getElementById('statusBadge');
        const summaryDisplay = document.getElementById('summaryDisplay');
        const reportMetadata = document.getElementById('reportMetadata');
        const reportHistory = document.getElementById('reportHistory');
        const clearSummaryBtn = document.getElementById('clearSummaryBtn');

        // State
        let uploadHistory = []; // stores {id, fileName, summary, timestamp}
        let isUploading = false;
        let currentSummary = '';

        // --- persistence helpers ---
        const HISTORY_KEY = 'mediCure_upload_history_v1';
        function loadHistoryFromSession() {
            try {
                const raw = sessionStorage.getItem(HISTORY_KEY);
                if (raw) {
                    const parsed = JSON.parse(raw);
                    if (Array.isArray(parsed)) uploadHistory = parsed;
                }
            } catch (e) {
                console.warn('Could not load history from sessionStorage', e);
                uploadHistory = [];
            }
        }
        function saveHistoryToSession() {
            try {
                sessionStorage.setItem(HISTORY_KEY, JSON.stringify(uploadHistory));
            } catch (e) {
                console.warn('Could not save history to sessionStorage', e);
            }
        }

        // UI helpers
        function setStatus(cls, text) {
            statusBadge.className = 'status-badge ' + cls;
            statusBadge.textContent = text;
        }
        function showLoading(on = true) {
            if (on) {
                loading.classList.add('active');
                loading.setAttribute('aria-hidden', 'false');
            } else {
                loading.classList.remove('active');
                loading.setAttribute('aria-hidden', 'true');
            }
        }
        function safeSetSummary(text) {
            currentSummary = String(text || '');
            // Use textContent (no layout thrash that innerText sometimes causes)
            summaryDisplay.textContent = currentSummary;
        }

        // Basic HTML escape for filenames
        function escapeHtml(s) {
            return String(s || '').replace(/[&<>"']/g, function(m) {
                return {'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m];
            });
        }

        // Render history UI
        function renderHistory() {
            if (!uploadHistory || uploadHistory.length <= 1) {
                reportHistory.style.display = 'none';
                return;
            }
            const items = uploadHistory.slice(1).map(h =>
                `<a class="history-link" data-id="${encodeURIComponent(h.id)}">${escapeHtml(h.fileName)}</a>`
            ).join(' ‚Ä¢ ');
            reportHistory.innerHTML = `<div class="report-history">üìö <strong>Upload History:</strong> ${items}</div>`;
            reportHistory.style.display = 'block';
        }

        // Clear summary (user action)
        clearSummaryBtn.addEventListener('click', () => {
            currentSummary = '';
            summaryDisplay.textContent = 'No report has been uploaded yet.';
            setStatus('status-waiting', '‚è≥ Waiting for upload');
            // Keep history intact
        });

        // File input change
        fileInput.addEventListener('change', (e) => {
            if (e.target.files && e.target.files.length > 0) {
                fileNameEl.textContent = `Selected: ${e.target.files[0].name}`;
            } else {
                fileNameEl.textContent = '';
            }
        });

        // Upload form submit - prevents default (no page reload)
        uploadForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            if (isUploading) return;

            const file = fileInput.files[0];
            if (!file) {
                alert('Please select a PDF file first.');
                return;
            }

            isUploading = true;
            uploadBtn.disabled = true;
            setStatus('status-processing', '‚è≥ Processing...');
            reportMetadata.style.display = 'none';
            reportHistory.style.display = 'none';
            showLoading(true);

            try {
                const formData = new FormData();
                formData.append('file', file);

                // Fetch with timeout using AbortController
                const controller = new AbortController();
                const timeoutMs = 60000;
                const tId = setTimeout(() => controller.abort(), timeoutMs);

                const response = await fetch('http://127.0.0.1:8000/report/upload', {
                    method: 'POST', body: formData, signal: controller.signal
                });

                clearTimeout(tId);

                if (!response.ok) {
                    const body = await response.text().catch(()=> 'No response body');
                    if (response.status === 429) {
                        throw new Error('429 Rate limited');
                    }
                    throw new Error(`Server error: ${response.status} - ${body}`);
                }

                const data = await response.json().catch(()=>null);
                if (!data) throw new Error('Invalid JSON response from server');

                if (data.success && data.summary) {
                    const entry = {
                        id: data.report_id ?? (Date.now().toString()),
                        fileName: data.file_name ?? file.name,
                        summary: data.summary,
                        timestamp: new Date().toLocaleString()
                    };
                    // store at top
                    uploadHistory.unshift(entry);
                    // persist session
                    saveHistoryToSession();
                    // render history if applicable
                    renderHistory();

                    // status badge
                    if (String(data.summary).includes('BASIC SUMMARY') || String(data.summary).toLowerCase().includes('rate limited')) {
                        setStatus('status-processing', '‚ö†Ô∏è Basic Summary (Rate Limited)');
                    } else {
                        setStatus('status-complete', '‚úì AI Analysis Complete');
                    }

                    // metadata
                    reportMetadata.innerHTML = `
                        <div class="report-metadata">
                            <p><strong>üìÑ File:</strong> ${escapeHtml(entry.fileName)}</p>
                            <p><strong>üÜî Report ID:</strong> ${escapeHtml(entry.id)}</p>
                            ${data.pages_processed ? `<p><strong>üìñ Pages:</strong> ${escapeHtml(String(data.pages_processed))}</p>` : ''}
                            ${data.chunks_created ? `<p><strong>‚úÇÔ∏è Chunks:</strong> ${escapeHtml(String(data.chunks_created))}</p>` : ''}
                            <p><strong>üïí Uploaded:</strong> ${escapeHtml(new Date().toLocaleString())}</p>
                        </div>
                    `;
                    reportMetadata.style.display = 'block';

                    // set and show summary (use textContent)
                    safeSetSummary(data.summary);

                    // reset file input UI (no full re-render)
                    fileInput.value = '';
                    fileNameEl.textContent = '';
                } else {
                    throw new Error('No summary in response');
                }
            } catch (err) {
                const msg = (err && err.message) ? err.message : String(err);
                console.error('Upload failed:', err);

                // show friendly summary for common cases
                if (msg.includes('429') || msg.toLowerCase().includes('rate limit')) {
                    safeSetSummary(`‚è≥ RATE LIMIT REACHED

The server reported rate limiting. Your file may be saved but AI analysis could be limited. Please try again in a minute or upgrade your plan.`);
                    setStatus('status-processing', '‚ö†Ô∏è Basic Summary (Rate Limited)');
                } else if (msg === 'The user aborted a request.') {
                    safeSetSummary(`ERROR: Request timed out. The server did not respond in time.`);
                    setStatus('status-error', '‚úó Request Timed Out');
                } else {
                    safeSetSummary(`ERROR: ${msg}

Possible causes:
‚Ä¢ Backend server is down
‚Ä¢ CORS / network issue
‚Ä¢ File failed parsing on server

Check browser console for more details.`);
                    setStatus('status-error', '‚úó Error Occurred');
                }

                reportMetadata.style.display = 'none';
                reportHistory.style.display = 'none';
            } finally {
                showLoading(false);
                uploadBtn.disabled = false;
                isUploading = false;
            }
        });

        // event delegation for history links
        reportHistory.addEventListener('click', (ev) => {
            const target = ev.target;
            if (target && target.classList && target.classList.contains('history-link')) {
                ev.preventDefault();
                const id = decodeURIComponent(target.dataset.id);
                loadReport(id);
            }
        });

        // Try cache first, then server
        async function loadReport(reportId) {
            // cached
            const cached = uploadHistory.find(h => String(h.id) === String(reportId));
            if (cached) {
                safeSetSummary(cached.summary);
                setStatus('status-complete', '‚úì Loaded from History');
                reportMetadata.innerHTML = `
                    <div class="report-metadata">
                        <p><strong>üìÑ File:</strong> ${escapeHtml(cached.fileName)}</p>
                        <p><strong>üÜî Report ID:</strong> ${escapeHtml(cached.id)}</p>
                        <p><strong>üïí Loaded:</strong> ${escapeHtml(cached.timestamp)}</p>
                    </div>
                `;
                reportMetadata.style.display = 'block';
                return;
            }

            try {
                setStatus('status-processing','‚è≥ Loading...');
                showLoading(true);

                const resp = await fetch(`http://127.0.0.1:8000/report/${encodeURIComponent(reportId)}`, { method:'GET' });
                if (!resp.ok) throw new Error('Report not found on server');
                const data = await resp.json();
                if (data.success && data.report) {
                    safeSetSummary(data.report.summary);
                    setStatus('status-complete', '‚úì Loaded from Database');
                    reportMetadata.innerHTML = `
                        <div class="report-metadata">
                            <p><strong>üìÑ File:</strong> ${escapeHtml(data.report.file_name)}</p>
                            <p><strong>üÜî Report ID:</strong> ${escapeHtml(data.report.id)}</p>
                            <p><strong>üïí Uploaded:</strong> ${escapeHtml(data.report.uploaded_at || 'N/A')}</p>
                        </div>
                    `;
                    reportMetadata.style.display = 'block';
                } else {
                    throw new Error('Invalid report data');
                }
            } catch (err) {
                setStatus('status-error', '‚úó Load Failed');
                safeSetSummary(`Error loading report: ${err && err.message ? err.message : String(err)}`);
                reportMetadata.style.display = 'none';
            } finally {
                showLoading(false);
            }
        }

        // logout helper
        function logout(event) {
            event.preventDefault();
            if (confirm('Are you sure you want to logout?')) {
                localStorage.removeItem('token');
                window.location.href = 'login.html';
            }
        }

        // init
        (function init(){
            loadHistoryFromSession();
            renderHistory();
            // if there's a last result in history, show it
            if (uploadHistory && uploadHistory.length > 0) {
                safeSetSummary(uploadHistory[0].summary);
                setStatus('status-complete', '‚úì Loaded last result');
                // show metadata for the latest if available
                reportMetadata.innerHTML = `
                    <div class="report-metadata">
                        <p><strong>üìÑ File:</strong> ${escapeHtml(uploadHistory[0].fileName)}</p>
                        <p><strong>üÜî Report ID:</strong> ${escapeHtml(uploadHistory[0].id)}</p>
                        <p><strong>üïí Loaded:</strong> ${escapeHtml(uploadHistory[0].timestamp)}</p>
                    </div>
                `;
                reportMetadata.style.display = 'block';
            }
        })();

        // expose logout to global scope (used in markup)
        window.logout = logout;

        // quick sanity
        if (!summaryDisplay) console.error('‚ùå summaryDisplay element not found!');
        else console.log('‚úÖ Upload report page ready (stable summary behavior)');
    })();
    </script>
</body>
</html>
